#!/bin/sh

# Skip husky hooks when running from Windows on WSL filesystem
case "$(uname -s)" in
  MINGW*|MSYS*|CYGWIN*)
    if echo "$PWD" | grep -q "^//wsl"; then
      echo "husky: Skipping pre-commit hook (Windows accessing WSL filesystem)"
      exit 0
    fi
    ;;
esac

# Husky v9+ friendly hook: avoid npx PATH issues (e.g., SourceTree embedded Git).

# Ensure Node is available. Try common install locations used by GUI Git clients
# (Homebrew, NVM) before giving up.
export PATH="$PWD/node_modules/.bin:$PATH"

if ! command -v node >/dev/null 2>&1; then
  # Homebrew (Apple Silicon default)
  [ -d "/opt/homebrew/bin" ] && PATH="/opt/homebrew/bin:$PATH"
fi

if ! command -v node >/dev/null 2>&1; then
  # Homebrew (Intel default)
  [ -d "/usr/local/bin" ] && PATH="/usr/local/bin:$PATH"
fi

if ! command -v node >/dev/null 2>&1; then
  # NVM default install
  if [ -d "$HOME/.nvm/versions/node" ]; then
    latest_node="$(ls -1 "$HOME/.nvm/versions/node" 2>/dev/null | sort -V | tail -1)"
    if [ -n "$latest_node" ] && [ -x "$HOME/.nvm/versions/node/$latest_node/bin/node" ]; then
      PATH="$HOME/.nvm/versions/node/$latest_node/bin:$PATH"
    fi
  fi
fi

if ! command -v node >/dev/null 2>&1; then
  echo "husky (pre-commit): node is not on PATH after checking common locations; skipping lint-staged." >&2
  exit 0
fi

npx lint-staged
