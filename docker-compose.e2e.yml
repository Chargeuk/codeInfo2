services:
  server:
    build:
      context: .
      dockerfile: server/Dockerfile
    image: codeinfo2-server-e2e
    ports:
      - '6010:5010'
    env_file:
      - server/.env
      - server/.env.local
    environment:
      - PORT=5010
      - CHROMA_URL=http://chroma-e2e:8000
      - INGEST_COLLECTION=ingest_vectors_e2e
      - INGEST_ROOTS_COLLECTION=ingest_roots_e2e
    volumes:
      - ./logs:/app/logs
      - ./e2e/fixtures:/fixtures:ro
    depends_on:
      chroma-e2e:
        condition: service_started
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:5010/health']
      interval: 10s
      timeout: 5s
      retries: 5

  client:
    build:
      context: .
      dockerfile: client/Dockerfile
    image: codeinfo2-client-e2e
    ports:
      - '6001:5001'
    env_file:
      - client/.env
      - client/.env.local
    environment:
      - VITE_API_URL=http://server:5010
    depends_on:
      server:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:5001']
      interval: 10s
      timeout: 5s
      retries: 5

  chroma-e2e:
    image: chromadb/chroma:1.3.5
    ports:
      - '8800:8000'
    volumes:
      - chroma-e2e-data:/chroma/.chroma

volumes:
  chroma-e2e-data:
