services:
  server:
    build:
      context: .
      dockerfile: server/Dockerfile
    image: codeinfo2-server-e2e
    ports:
      - '6010:5010'
    env_file:
      - server/.env.e2e
    volumes:
      - ./logs:/app/logs
      - ./e2e/fixtures:/fixtures:ro
    depends_on:
      chroma-e2e:
        condition: service_started
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:5010/health']
      interval: 10s
      timeout: 5s
      retries: 5

  client:
    build:
      context: .
      dockerfile: client/Dockerfile
      args:
        VITE_API_URL: ${VITE_API_URL:-http://localhost:6010}
        VITE_LMSTUDIO_URL: ${VITE_LMSTUDIO_URL:-http://host.docker.internal:1234}
    image: codeinfo2-client-e2e
    ports:
      - '6001:5001'
    env_file:
      - client/.env.e2e
    depends_on:
      server:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:5001']
      interval: 10s
      timeout: 5s
      retries: 5

  chroma-e2e:
    image: chromadb/chroma:1.3.5
    ports:
      - '8800:8000'
    volumes:
      - /chroma/.chroma
